<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Communauté d’Atloc · Portail public</title>
  <meta name="description" content="Portail public de la Communauté d’Atloc. Accès interne ASC." />

  <!--
    TEST
    identifiant: 0175
    mot de passe: 1234

    ARG
    Le site est conçu pour évoluer par accréditations.
    Tu peux rajouter dossiers, incidents, niveaux, et règles de déblocage en éditant DATA au bas du fichier.
  -->

  <style>
    :root{
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;

      /* Public: style "Apple-like" */
      --p-bg: #0b0f16;
      --p-card: rgba(255,255,255,.08);
      --p-card2: rgba(255,255,255,.10);
      --p-line: rgba(255,255,255,.14);
      --p-text: rgba(255,255,255,.92);
      --p-muted: rgba(255,255,255,.66);
      --p-accent: #9bf00b;
      --p-blue: #76b9ff;
      --p-shadow: 0 18px 70px rgba(0,0,0,.45);
      --p-radius: 22px;

      /* Interne: style "Windows 95" */
      --w-bg: #008080;
      --w-window: #c0c0c0;
      --w-border-dark: #404040;
      --w-border-light: #ffffff;
      --w-border-mid: #808080;
      --w-title: #000080;
      --w-titleText: #ffffff;
      --w-text: #000000;
      --w-muted: #202020;
      --w-green: #00ff00;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(118,185,255,.18), transparent 60%),
                  radial-gradient(1200px 800px at 80% 25%, rgba(155,240,11,.12), transparent 60%),
                  var(--p-bg);
      color: var(--p-text);
      letter-spacing: .1px;
    }
    a{color:inherit;text-decoration:none}
    button,input,select{font-family:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:26px 18px 60px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;
      border:1px solid var(--p-line);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(12px);
      box-shadow: var(--p-shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:280px}
    .mark{
      width:42px;height:42px;border-radius: 16px;
      border:1px solid var(--p-line);
      background: radial-gradient(18px 18px at 30% 30%, rgba(155,240,11,.35), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.03));
      display:grid;place-items:center;
      font-weight:800;
      letter-spacing: .8px;
    }
    .brand h1{margin:0;font-size:14px;font-weight:800;line-height:1.15}
    .brand p{margin:2px 0 0;font-size:12px;color: var(--p-muted)}

    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--p-line);
      background: rgba(255,255,255,.06);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: transform .08s ease, background .2s ease;
      color: var(--p-text);
    }
    .chip:hover{transform: translateY(-1px);background: rgba(255,255,255,.09)}
    .chip[aria-current="page"]{
      border-color: rgba(155,240,11,.35);
      background: rgba(155,240,11,.10);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.55fr .85fr;
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:unset}
    }

    .card{
      border:1px solid var(--p-line);
      border-radius: var(--p-radius);
      background: linear-gradient(180deg, var(--p-card2), var(--p-card));
      box-shadow: var(--p-shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 18px;
      border-bottom:1px solid var(--p-line);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
    }
    .cardHeader h2{margin:0;font-size:14px;font-weight:800}
    .sub{margin:4px 0 0;font-size:12px;line-height:1.45;color:var(--p-muted)}
    .cardBody{padding:18px}

    .hero{
      padding:18px;
      border:1px solid var(--p-line);
      border-radius: 18px;
      background: radial-gradient(600px 260px at 20% 10%, rgba(118,185,255,.18), transparent 60%),
                  radial-gradient(600px 260px at 80% 30%, rgba(155,240,11,.14), transparent 60%),
                  rgba(0,0,0,.25);
    }
    .heroTitle{margin:0;font-size:18px;font-weight:850;letter-spacing:.2px}
    .heroText{margin:8px 0 0;color:var(--p-muted);font-size:12px;line-height:1.55}

    .tiles{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin-top:14px}
    @media (max-width: 520px){ .tiles{grid-template-columns:1fr} }
    .tile{
      border:1px solid var(--p-line);
      border-radius: 16px;
      padding:12px 12px;
      background: rgba(255,255,255,.05);
    }
    .tile .t{margin:0 0 6px;font-size:12px;font-weight:850}
    .tile .d{margin:0;font-size:12px;color:var(--p-muted);line-height:1.45}

    .pill{
      display:inline-flex;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid var(--p-line);
      background: rgba(255,255,255,.06);
      font-size:11px;
      color: var(--p-muted);
      align-items:center;
      gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.35)}
    .pill.accent{border-color: rgba(155,240,11,.35); color: rgba(155,240,11,.92); background: rgba(155,240,11,.08)}
    .pill.blue{border-color: rgba(118,185,255,.35); color: rgba(118,185,255,.95); background: rgba(118,185,255,.08)}

    .field{display:grid;gap:8px;margin-top:12px}
    label{font-size:12px;color:var(--p-muted)}
    input{
      border:1px solid var(--p-line);
      background: rgba(255,255,255,.06);
      color: var(--p-text);
      border-radius: 16px;
      padding:10px 12px;
      font-size:12px;
      outline:none;
    }
    input::placeholder{color: rgba(255,255,255,.35)}
    input:focus{
      border-color: rgba(155,240,11,.35);
      box-shadow: 0 0 0 3px rgba(155,240,11,.12);
    }
    .btnRow{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-top:12px}
    .btn{
      border:1px solid var(--p-line);
      border-radius: 16px;
      padding:10px 12px;
      font-size:12px;
      cursor:pointer;
      color: var(--p-text);
      background: rgba(255,255,255,.06);
      transition: transform .08s ease, background .2s ease;
    }
    .btn:hover{transform: translateY(-1px);background: rgba(255,255,255,.09)}
    .btn.primary{
      border-color: rgba(155,240,11,.35);
      background: rgba(155,240,11,.12);
      color: rgba(155,240,11,.95);
      font-weight:800;
    }

    .footer{
      margin-top:14px;
      font-size:11px;
      color: var(--p-muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ====== Loader plein écran, barre verte à crans ====== */
    .loader{
      position:fixed;
      inset:0;
      display:none;
      z-index: 500;
      background: #000;
      color: #0f0;
      font-family: var(--mono);
      padding: 0;
    }
    .loaderCenter{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding: 18px;
    }
    .segWrap{
      width:min(980px, calc(100vw - 36px));
    }
    .segTitle{
      color: rgba(0,255,0,.85);
      font-size:12px;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      margin:0 0 10px;
    }
    .segBar{
      display:grid;
      grid-template-columns: repeat(40, 1fr);
      gap: 3px;
      padding: 10px;
      border: 1px solid rgba(0,255,0,.35);
      background: rgba(0,0,0,.65);
    }
    .seg{
      height: 12px;
      border: 1px solid rgba(0,255,0,.18);
      background: rgba(0,255,0,.04);
    }
    .seg.on{
      background: rgba(0,255,0,.85);
      border-color: rgba(0,255,0,.55);
    }
    .segNote{
      margin-top:10px;
      color: rgba(0,255,0,.65);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ====== Interne: "Windows 95" ====== */
    body.internal{
      background: var(--w-bg);
      color: var(--w-text);
      font-family: var(--sans);
      letter-spacing: 0;
    }
    body.internal .wrap{max-width: 980px}
    body.internal .topbar{
      border-radius: 0;
      border: none;
      background: transparent;
      box-shadow: none;
      padding: 0;
      margin-bottom: 12px;
    }
    body.internal .brand, body.internal .nav{display:none}

    .winWindow{
      background: var(--w-window);
      padding: 2px;
      border-top: 2px solid var(--w-border-light);
      border-left: 2px solid var(--w-border-light);
      border-right: 2px solid var(--w-border-dark);
      border-bottom: 2px solid var(--w-border-dark);
    }
    .winTitlebar{
      background: var(--w-title);
      color: var(--w-titleText);
      padding: 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 700;
    }
    .winBtns{display:flex;gap:6px}
    .winBtn{
      width:18px;height:18px;
      background: var(--w-window);
      border-top: 2px solid var(--w-border-light);
      border-left: 2px solid var(--w-border-light);
      border-right: 2px solid var(--w-border-dark);
      border-bottom: 2px solid var(--w-border-dark);
      display:grid;place-items:center;
      color: var(--w-text);
      font-size: 12px;
      line-height: 1;
      cursor:pointer;
      user-select:none;
    }
    .winBody{
      padding: 10px;
      font-size: 12px;
      color: var(--w-text);
    }
    .winRow{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 10px;
    }
    @media (max-width: 900px){
      .winRow{grid-template-columns:1fr}
    }

    .panel{
      background: var(--w-window);
      padding: 8px;
      border-top: 2px solid var(--w-border-light);
      border-left: 2px solid var(--w-border-light);
      border-right: 2px solid var(--w-border-dark);
      border-bottom: 2px solid var(--w-border-dark);
    }
    .panelTitle{
      font-weight:700;
      margin:0 0 8px;
    }
    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:6px 10px;
      margin-top: 6px;
    }
    .kv div:nth-child(odd){color: var(--w-muted)}
    .kv div:nth-child(even){color: var(--w-text)}
    .hr{
      height:2px;
      background: var(--w-border-mid);
      margin: 10px 0;
      border-top: 1px solid var(--w-border-light);
    }

    .menuBtn{
      width:100%;
      text-align:left;
      padding:6px 8px;
      background: var(--w-window);
      cursor:pointer;
      border-top: 2px solid var(--w-border-light);
      border-left: 2px solid var(--w-border-light);
      border-right: 2px solid var(--w-border-dark);
      border-bottom: 2px solid var(--w-border-dark);
      margin-bottom: 8px;
      font-size: 12px;
    }
    .menuBtn[aria-selected="true"]{
      outline: 1px dotted #000;
      background: #dcdcdc;
    }

    .lvlBox{
      background: #dcdcdc;
      padding: 6px;
      border-top: 2px solid var(--w-border-light);
      border-left: 2px solid var(--w-border-light);
      border-right: 2px solid var(--w-border-dark);
      border-bottom: 2px solid var(--w-border-dark);
    }
    .lvlTitle{margin:0 0 6px;font-weight:700}
    .lvlGrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:6px;
    }
    @media (max-width: 520px){
      .lvlGrid{grid-template-columns: repeat(3, 1fr)}
    }
    .lvlItem{
      display:flex;
      align-items:center;
      gap:6px;
      font-size: 12px;
      user-select:none;
    }
    .lvlItem input{transform: translateY(1px)}
    .hint{
      color: var(--w-muted);
      font-size: 12px;
      margin-top: 6px;
    }

    table.winTable{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      color:#000;
      border: 1px solid #000;
    }
    table.winTable th, table.winTable td{
      border: 1px solid #000;
      padding: 6px 6px;
      vertical-align:top;
    }
    table.winTable th{
      background: #e6e6e6;
      font-weight:700;
    }
    .redact{
      display:inline-block;
      padding:2px 6px;
      background: #000;
      color: #000;
      user-select:none;
    }

    .winInput{
      width:100%;
      padding:6px 8px;
      background: #fff;
      border-top: 2px solid var(--w-border-dark);
      border-left: 2px solid var(--w-border-dark);
      border-right: 2px solid var(--w-border-light);
      border-bottom: 2px solid var(--w-border-light);
      font-size: 12px;
    }
    .winActionRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .winAction{
      padding:6px 10px;
      background: var(--w-window);
      border-top: 2px solid var(--w-border-light);
      border-left: 2px solid var(--w-border-light);
      border-right: 2px solid var(--w-border-dark);
      border-bottom: 2px solid var(--w-border-dark);
      cursor:pointer;
      font-size: 12px;
    }
    .winNote{
      margin-top: 8px;
      color: var(--w-muted);
      font-size: 12px;
    }

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      display:none;
      z-index: 600;
      background: rgba(0,0,0,.85);
      color:#fff;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 14px;
      padding: 10px 12px;
      width: min(420px, calc(100vw - 28px));
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      font-size: 12px;
    }
    .toast .t1{font-weight:800}
    .toast .t2{margin-top:4px;color: rgba(255,255,255,.76);line-height:1.35}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="topbar" id="publicTopbar">
      <div class="brand">
        <div class="mark" aria-hidden="true">A</div>
        <div>
          <h1 id="brandTitle">La Communauté d’Atloc</h1>
          <p id="brandSub">Optimisme, entraide, accès simple</p>
        </div>
      </div>

      <nav class="nav" aria-label="Navigation" id="publicNav">
        <div class="chip" data-page="accueil" aria-current="page">Accueil</div>
        <div class="chip" data-page="communaute">La Communauté</div>
        <div class="chip" data-page="aam">AAM</div>
        <div class="chip" data-page="asc">ASC</div>
        <div class="chip" data-page="connexion">Connexion</div>
      </nav>
    </header>

    <main class="grid" id="publicGrid">
      <section class="card">
        <div class="cardHeader">
          <div>
            <h2 id="publicTitle">Atloc</h2>
            <div class="sub" id="publicSub">Une ville construite autour de la Communauté.</div>
          </div>
          <div class="pill accent"><span class="dot"></span><span>PORTAIL PUBLIC</span></div>
        </div>
        <div class="cardBody" id="publicBody"></div>
      </section>

      <aside class="card">
        <div class="cardHeader">
          <div>
            <h2>Accès</h2>
            <div class="sub">Espace interne ASC</div>
          </div>
          <div class="pill blue"><span class="dot"></span><span>CONNEXION</span></div>
        </div>
        <div class="cardBody">
          <div class="sub" style="margin:0">
            L’espace interne est distinct du portail public.
          </div>

          <div class="field">
            <label for="u">Identifiant</label>
            <input id="u" autocomplete="off" inputmode="numeric" placeholder="ex: 0175" />
          </div>
          <div class="field">
            <label for="p">Mot de passe</label>
            <input id="p" type="password" autocomplete="off" placeholder="●●●●" />
          </div>

          <div class="btnRow">
            <button class="btn primary" id="loginBtn">Se connecter</button>
            <button class="btn" id="demoBtn">Test</button>
          </div>

          <div class="footer">
            <span>Communauté</span>
            <span>ASC</span>
          </div>
        </div>
      </aside>
    </main>

    <!-- Interne Win95 -->
    <main id="internalRoot" style="display:none;margin-top:12px">
      <div class="winWindow">
        <div class="winTitlebar">
          <div id="winTitle">ASC Console interne</div>
          <div class="winBtns">
            <div class="winBtn" title="Réduire">_</div>
            <div class="winBtn" title="Agrandir">□</div>
            <div class="winBtn" id="logoutX" title="Fermer">✕</div>
          </div>
        </div>
        <div class="winBody">
          <div class="winRow">
            <div class="panel">
              <p class="panelTitle">Session</p>
              <div class="kv">
                <div>Agent</div><div id="agentId">0175</div>
                <div>Niveau</div><div id="agentLevel">3</div>
                <div>Affectation</div><div>Atloc</div>
                <div>Mode</div><div>lecture</div>
              </div>

              <div class="hr"></div>

              <p class="panelTitle">Affichage des niveaux</p>
              <div class="lvlBox">
                <p class="lvlTitle">Niveaux visibles</p>
                <div class="lvlGrid" id="lvlGrid"></div>
                <div class="hint" id="lvlHint"></div>
              </div>

              <div class="hr"></div>

              <button class="menuBtn" data-tab="dossiers" aria-selected="true">Dossiers</button>
              <button class="menuBtn" data-tab="incidents" aria-selected="false">Incidents</button>
              <button class="menuBtn" data-tab="recherche" aria-selected="false">Recherche</button>

              <div class="hr"></div>

              <button class="menuBtn" id="logoutBtn" aria-selected="false">Fermer la session</button>
            </div>

            <div class="panel">
              <div id="tab_dossiers">
                <p class="panelTitle">Dossiers enfants</p>
                <div class="hint" id="dossiersHint"></div>
                <div style="margin-top:8px">
                  <table class="winTable" aria-label="Dossiers">
                    <thead>
                      <tr>
                        <th>ID enfant</th>
                        <th>Accès</th>
                        <th>Détails</th>
                      </tr>
                    </thead>
                    <tbody id="dossiersBody"></tbody>
                  </table>
                </div>
                <div class="winNote">Au niveau 3, seuls certains enfants sont visibles pour cet agent.</div>
              </div>

              <div id="tab_incidents" style="display:none">
                <p class="panelTitle">Incidents</p>
                <div class="hint" id="incidentsHint"></div>
                <div style="margin-top:8px">
                  <table class="winTable" aria-label="Incidents">
                    <thead>
                      <tr>
                        <th>ID enfant</th>
                        <th>État</th>
                        <th>Raison</th>
                        <th>Lieu</th>
                      </tr>
                    </thead>
                    <tbody id="incidentsBody"></tbody>
                  </table>
                </div>
                <div class="winNote">La liste est globale. Les détails sont affichés seulement si l’enfant est autorisé ou si le niveau visible le permet.</div>
              </div>

              <div id="tab_recherche" style="display:none">
                <p class="panelTitle">Recherche</p>
                <div class="hint">Entrer une référence exacte. Les mots clés sont ignorés.</div>
                <input class="winInput" id="q" autocomplete="off" placeholder="ex: M 44703" />
                <div class="winActionRow">
                  <button class="winAction" id="searchBtn">Rechercher</button>
                  <button class="winAction" id="clearBtn">Effacer</button>
                </div>
                <div class="hr"></div>
                <div id="searchResult" class="hint">Aucune requête.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="loaderCenter">
      <div class="segWrap">
        <p class="segTitle">Chargement interface interne</p>
        <div class="segBar" id="segBar"></div>
        <div class="segNote">
          <span id="segLeft">initialisation</span>
          <span id="segRight">0%</span>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true">
    <div class="t1" id="toastT1">Info</div>
    <div class="t2" id="toastT2">Message</div>
  </div>

  <script>
    /* =========================
       DATA: modifie ici ensuite
       ========================= */

    const DATA = {
      pages: {
        accueil: `
          <div class="hero">
            <p class="heroTitle">Bienvenue à Atloc</p>
            <p class="heroText">
              La Communauté est le cœur de la ville.
              Un endroit où l’entraide est un réflexe, où les services sont clairs, et où les trajets sont simples.
            </p>
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
              <span class="pill accent"><span class="dot"></span>Communauté Hall d’Aurore</span>
              <span class="pill blue"><span class="dot"></span>AAM</span>
              <span class="pill"><span class="dot"></span>ASC</span>
            </div>
          </div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Hall d’Aurore</p>
              <p class="d">8 étages. Point central. Accès métro A rouge et Central Line orange.</p>
            </div>
            <div class="tile">
              <p class="t">Mobilité</p>
              <p class="d">AAM relie les quartiers avec une signalétique simple et constante.</p>
            </div>
            <div class="tile">
              <p class="t">Accompagnement</p>
              <p class="d">Des missions ponctuelles existent pour sécuriser des retours et guider les parcours.</p>
            </div>
          </div>
        `,
        communaute: `
          <div class="hero">
            <p class="heroTitle">La Communauté</p>
            <p class="heroText">
              Le Hall d’Aurore accueille, oriente, et met en lien.
              Les relais de quartier complètent le dispositif.
            </p>
          </div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Un lieu</p>
              <p class="d">Le Hall d’Aurore. Visible, central, accessible.</p>
            </div>
            <div class="tile">
              <p class="t">Un réseau</p>
              <p class="d">Des relais. Des parcours simples. Une continuité.</p>
            </div>
            <div class="tile">
              <p class="t">Un symbole</p>
              <p class="d">L’optimisme comme méthode.</p>
            </div>
          </div>
        `,
        aam: `
          <div class="hero">
            <p class="heroTitle">AAM</p>
            <p class="heroText">
              Atloc Area Mobility.
              Des lignes lisibles, des correspondances pratiques, et une ville pensée pour être parcourue.
            </p>
          </div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Métro A</p>
              <p class="d">Rouge. Accès direct au Hall d’Aurore.</p>
            </div>
            <div class="tile">
              <p class="t">Central Line</p>
              <p class="d">Orange. Traverse le centre.</p>
            </div>
            <div class="tile">
              <p class="t">Accessibilité</p>
              <p class="d">Les lieux essentiels sont prévus dans le réseau.</p>
            </div>
          </div>
        `,
        asc: `
          <div class="hero">
            <p class="heroTitle">ASC</p>
            <p class="heroText">
              Service partenaire de la Communauté, en lien avec le gouvernement d’Atloc.
              Certaines équipes peuvent être mandatées pour retrouver des enfants et sécuriser un retour.
            </p>
          </div>

          <div class="tiles">
            <div class="tile">
              <p class="t">Mandat</p>
              <p class="d">Retrouver et guider, sur demande.</p>
            </div>
            <div class="tile">
              <p class="t">Coordination</p>
              <p class="d">Lien avec le Hall d’Aurore et les relais.</p>
            </div>
            <div class="tile">
              <p class="t">Cadre</p>
              <p class="d">Procédures internes réservées aux agents.</p>
            </div>
          </div>
        `,
        connexion: `
          <div class="hero">
            <p class="heroTitle">Connexion</p>
            <p class="heroText">
              L’espace interne est réservé.
              Il ne ressemble pas au portail public.
            </p>
          </div>
          <div class="tiles">
            <div class="tile">
              <p class="t">Conseil</p>
              <p class="d">Utilise uniquement un identifiant attribué.</p>
            </div>
            <div class="tile">
              <p class="t">Sécurité</p>
              <p class="d">Chaque tentative est enregistrée.</p>
            </div>
            <div class="tile">
              <p class="t">Accréditations</p>
              <p class="d">Le contenu dépend du niveau.</p>
            </div>
          </div>
        `
      },

      agents: {
        "0175": {
          password: "1234",
          level: 3,
          childrenAllowed: ["M 44703","M 44590","M 44218"]
        }
      },

      dossiers: [
        { id:"M 44703" },
        { id:"M 44590" },
        { id:"M 44218" },
        { id:"M 44821" },
        { id:"M 44002" },
        { id:"M 43911" }
      ],

      incidents: [
        { childId:"M 44703", state:"décédé", reason:"accident ferroviaire", place:"station non desservie (CPC)", minVisibleLevel: 1 },
        { childId:"M 44590", state:"décédé", reason:"chute", place:"couloir de service AAM", minVisibleLevel: 2 },
        { childId:"M 44218", state:"décédé", reason:"incident classé", place:"périmètre CPC", minVisibleLevel: 3 },

        { childId:"M 44821", state:"décédé", reason:"requalifié", place:"secteur résidentiel", minVisibleLevel: 6 },
        { childId:"M 44002", state:"décédé", reason:"indéterminé", place:"infrastructure transport", minVisibleLevel: 7 },
        { childId:"M 43911", state:"décédé", reason:"annexe indisponible", place:"lieu masqué", minVisibleLevel: 8 }
      ]
    };

    /* =========================
       ÉTAT
       ========================= */

    const state = {
      page: "accueil",
      logged: false,
      agentId: null,
      level: 0,
      levelsVisible: new Set([1,2,3]),
      tab: "dossiers"
    };

    /* =========================
       UI refs public
       ========================= */

    const chips = Array.from(document.querySelectorAll(".chip"));
    const publicTitle = document.getElementById("publicTitle");
    const publicSub = document.getElementById("publicSub");
    const publicBody = document.getElementById("publicBody");

    const u = document.getElementById("u");
    const p = document.getElementById("p");
    const loginBtn = document.getElementById("loginBtn");
    const demoBtn = document.getElementById("demoBtn");

    const publicGrid = document.getElementById("publicGrid");
    const internalRoot = document.getElementById("internalRoot");

    const loader = document.getElementById("loader");
    const segBar = document.getElementById("segBar");
    const segLeft = document.getElementById("segLeft");
    const segRight = document.getElementById("segRight");

    const toast = document.getElementById("toast");
    const toastT1 = document.getElementById("toastT1");
    const toastT2 = document.getElementById("toastT2");

    /* =========================
       UI refs interne
       ========================= */

    const agentIdEl = document.getElementById("agentId");
    const agentLevelEl = document.getElementById("agentLevel");
    const lvlGrid = document.getElementById("lvlGrid");
    const lvlHint = document.getElementById("lvlHint");

    const menuBtns = Array.from(document.querySelectorAll(".menuBtn")).filter(b => b.dataset.tab);
    const tabDossiers = document.getElementById("tab_dossiers");
    const tabIncidents = document.getElementById("tab_incidents");
    const tabRecherche = document.getElementById("tab_recherche");

    const dossiersBody = document.getElementById("dossiersBody");
    const incidentsBody = document.getElementById("incidentsBody");
    const dossiersHint = document.getElementById("dossiersHint");
    const incidentsHint = document.getElementById("incidentsHint");

    const q = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearBtn");
    const searchResult = document.getElementById("searchResult");

    const logoutBtn = document.getElementById("logoutBtn");
    const logoutX = document.getElementById("logoutX");

    /* =========================
       Helpers
       ========================= */

    function toastMsg(title, msg){
      toastT1.textContent = title;
      toastT2.textContent = msg;
      toast.style.display = "block";
      clearTimeout(toastMsg._t);
      toastMsg._t = setTimeout(() => toast.style.display = "none", 3300);
    }

    function setPage(key){
      state.page = key;
      chips.forEach(c => c.setAttribute("aria-current", c.dataset.page === key ? "page" : "false"));

      const html = DATA.pages[key] || DATA.pages.accueil;
      publicTitle.textContent = (key === "accueil") ? "Atloc" :
                                (key === "communaute") ? "La Communauté" :
                                (key === "aam") ? "AAM" :
                                (key === "asc") ? "ASC" :
                                (key === "connexion") ? "Connexion" :
                                "Atloc";

      publicSub.textContent = (key === "accueil") ? "Une ville construite autour de la Communauté." :
                            (key === "communaute") ? "Le Hall d’Aurore au centre." :
                            (key === "aam") ? "Atloc Area Mobility." :
                            (key === "asc") ? "Service partenaire." :
                            (key === "connexion") ? "Accès interne." :
                            "";

      publicBody.innerHTML = html;
    }

    function redact(text){
      const n = Math.max(10, String(text).length);
      return `<span class="redact">${"█".repeat(n)}</span>`;
    }

    function normalizeRef(s){
      return (s || "")
        .replace(/[-_]/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .toUpperCase();
    }

    function maxVisibleLevel(){
      let m = 0;
      for(const lv of state.levelsVisible) m = Math.max(m, lv);
      return m;
    }

    /* =========================
       Loader segmented bar
       ========================= */

    function buildSegs(){
      segBar.innerHTML = "";
      for(let i=0;i<40;i++){
        const d = document.createElement("div");
        d.className = "seg";
        segBar.appendChild(d);
      }
    }

    async function playLoader(){
      buildSegs();
      loader.style.display = "block";
      segLeft.textContent = "initialisation";
      segRight.textContent = "0%";

      const segs = Array.from(segBar.children);
      const steps = segs.length;

      const phases = [
        "initialisation",
        "vérification des droits",
        "chargement dossiers",
        "chargement incidents",
        "chargement recherche",
        "synchronisation",
        "nettoyage",
        "prêt"
      ];

      for(let i=0;i<steps;i++){
        segs[i].classList.add("on");
        const pct = Math.round(((i+1)/steps)*100);
        segRight.textContent = pct + "%";
        segLeft.textContent = phases[Math.min(phases.length-1, Math.floor((i/steps)*phases.length))];

        const wait = 220 + Math.floor(Math.random()*520);
        await new Promise(r => setTimeout(r, wait));
      }

      await new Promise(r => setTimeout(r, 450));
      loader.style.display = "none";
    }

    /* =========================
       Interne rendering
       ========================= */

    function renderLevelSelector(){
      lvlGrid.innerHTML = "";

      for(let lv=1; lv<=state.level; lv++){
        const id = "lv_" + lv;
        const wrap = document.createElement("label");
        wrap.className = "lvlItem";
        wrap.innerHTML = `
          <input type="checkbox" id="${id}" ${state.levelsVisible.has(lv) ? "checked" : ""} />
          <span>${lv}</span>
        `;

        const cb = wrap.querySelector("input");
        cb.addEventListener("change", () => {
          if(cb.checked){
            state.levelsVisible.add(lv);
          } else {
            state.levelsVisible.delete(lv);
          }

          if(state.levelsVisible.size === 0){
            state.levelsVisible.add(state.level);
            cb.checked = (lv === state.level);
          }

          lvlHint.textContent = "niveau maximum visible: " + maxVisibleLevel();
          renderAllInternal();
        });

        lvlGrid.appendChild(wrap);
      }

      lvlHint.textContent = "niveau maximum visible: " + maxVisibleLevel();
    }

    function setTab(tab){
      state.tab = tab;

      tabDossiers.style.display = (tab === "dossiers") ? "block" : "none";
      tabIncidents.style.display = (tab === "incidents") ? "block" : "none";
      tabRecherche.style.display = (tab === "recherche") ? "block" : "none";

      menuBtns.forEach(b => b.setAttribute("aria-selected", b.dataset.tab === tab ? "true" : "false"));

      renderAllInternal();
    }

    function renderDossiers(){
      const agent = DATA.agents[state.agentId];
      const allowed = new Set(agent.childrenAllowed);

      dossiersHint.textContent = "enfants autorisés pour cet agent: " + agent.childrenAllowed.length;

      dossiersBody.innerHTML = "";
      for(const id of agent.childrenAllowed){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${id}</td>
          <td>autorisé</td>
          <td>${redact("notes")}</td>
        `;
        dossiersBody.appendChild(tr);
      }
    }

    function canSeeIncidentDetails(ev, agentAllowedSet, visibleMaxLv){
      if(agentAllowedSet.has(ev.childId)) return true;
      if(visibleMaxLv >= (ev.minVisibleLevel || 10)) return true;
      return false;
    }

    function renderIncidents(){
      const agent = DATA.agents[state.agentId];
      const allowed = new Set(agent.childrenAllowed);
      const visibleMaxLv = maxVisibleLevel();

      incidentsHint.textContent = "affichage incidents: niveau max " + visibleMaxLv;

      incidentsBody.innerHTML = "";
      for(const ev of DATA.incidents){
        const ok = canSeeIncidentDetails(ev, allowed, visibleMaxLv);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ev.childId}</td>
          <td>${ev.state}</td>
          <td>${ok ? ev.reason : redact(ev.reason)}</td>
          <td>${ok ? ev.place : redact(ev.place)}</td>
        `;
        incidentsBody.appendChild(tr);
      }
    }

    function renderSearch(){
      searchResult.textContent = "Aucune requête.";
    }

    function renderAllInternal(){
      if(state.tab === "dossiers") renderDossiers();
      if(state.tab === "incidents") renderIncidents();
      if(state.tab === "recherche") {}
    }

    /* =========================
       Login and enter internal
       ========================= */

    async function login(){
      const id = (u.value || "").trim();
      const pw = (p.value || "").trim();

      await new Promise(r => setTimeout(r, 160 + Math.floor(Math.random()*320)));

      const agent = DATA.agents[id];
      if(!agent || agent.password !== pw){
        toastMsg("Accès refusé", "tentative enregistrée");
        p.value = "";
        p.focus();
        return;
      }

      state.logged = true;
      state.agentId = id;
      state.level = agent.level;
      state.levelsVisible = new Set([]);
      for(let lv=1; lv<=state.level; lv++) state.levelsVisible.add(lv);

      await playLoader();
      enterInternal();
    }

    function enterInternal(){
      document.body.classList.add("internal");

      publicGrid.style.display = "none";
      document.getElementById("publicTopbar").style.display = "none";

      internalRoot.style.display = "block";

      agentIdEl.textContent = state.agentId;
      agentLevelEl.textContent = String(state.level);

      renderLevelSelector();
      setTab("dossiers");

      toastMsg("Session", "active, niveau " + state.level);
    }

    function logout(){
      state.logged = false;
      state.agentId = null;
      state.level = 0;
      state.levelsVisible = new Set([1]);

      document.body.classList.remove("internal");
      internalRoot.style.display = "none";

      document.getElementById("publicTopbar").style.display = "flex";
      publicGrid.style.display = "grid";

      u.value = "";
      p.value = "";
      q.value = "";
      searchResult.textContent = "Aucune requête.";

      setPage("accueil");
      toastMsg("Session", "fermée");
    }

    /* =========================
       Search behavior with levels
       ========================= */

    function doSearch(){
      const key = normalizeRef(q.value);
      if(!key){
        searchResult.textContent = "Aucune requête.";
        return;
      }

      const agent = DATA.agents[state.agentId];
      const allowed = new Set(agent.childrenAllowed);
      const visibleMaxLv = maxVisibleLevel();

      const dossier = DATA.dossiers.find(d => d.id === key);
      if(dossier){
        const ok = allowed.has(dossier.id) || visibleMaxLv >= 4;
        searchResult.innerHTML = ok
          ? `dossier ${dossier.id}\nstatut: clos\nhistorique: non nécessaire`
          : `dossier ${dossier.id}\n${"contenu: "}${"█".repeat(16)}`;
        return;
      }

      const incident = DATA.incidents.find(i => i.childId === key);
      if(incident){
        const ok = canSeeIncidentDetails(incident, allowed, visibleMaxLv);
        searchResult.innerHTML = ok
          ? `incident ${incident.childId}\nétat: ${incident.state}\nraison: ${incident.reason}\nlieu: ${incident.place}`
          : `incident ${incident.childId}\nétat: ${incident.state}\nraison: ${"█".repeat(16)}\nlieu: ${"█".repeat(16)}`;
        return;
      }

      const forbidden = ["ENFANT","MORT","MEURTRE","DISPARITION","ASE","ATLOC","CPC","DÉCÈS","DECES"];
      if(forbidden.includes(key)){
        searchResult.textContent = "0 résultat. Affiner la requête.";
        return;
      }

      if(key === "DÉCÉDÉ" || key === "DECEDÉ" || key === "DECÉDÉ"){
        searchResult.textContent = "décédé\ndécédé\ndécédé\nannexe: ████████████████";
        return;
      }

      searchResult.textContent = "aucun résultat. cette information peut ne pas avoir existé.";
    }

    /* =========================
       Events wiring
       ========================= */

    chips.forEach(ch => ch.addEventListener("click", () => setPage(ch.dataset.page)));
    loginBtn.addEventListener("click", login);
    demoBtn.addEventListener("click", () => { u.value = "0175"; p.value = "1234"; toastMsg("Test", "identifiants insérés"); });

    [u,p].forEach(el => el.addEventListener("keydown", e => {
      if(e.key === "Enter") login();
    }));

    menuBtns.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

    logoutBtn.addEventListener("click", logout);
    logoutX.addEventListener("click", logout);

    searchBtn.addEventListener("click", doSearch);
    clearBtn.addEventListener("click", () => { q.value = ""; searchResult.textContent = "Aucune requête."; });
    q.addEventListener("keydown", e => { if(e.key === "Enter") doSearch(); });

    setPage("accueil");
  </script>
</body>
</html>
